# Cloudflare Workers Deployment Guide

This document explains how the TanStack Start application is configured for **pure Cloudflare Workers** deployment (not Cloudflare Pages) as a fullstack application with server-side rendering (SSR) and API routes.

---

## ðŸš¨ CRITICAL: Multi-Worker Deployment Order

This project uses **THREE separate Cloudflare Workers**:

1. `ameenuddin-transcription-ws` - WebSocket for real-time speech-to-text (`/demo/api/ai/transcription`)
2. `ameenuddin-tts-ws` - WebSocket for text-to-speech (`/demo/api/ai/tts-stream`)
3. `ameenuddin` - Main TanStack Start app (wildcard route `/*`)

### Deployment Order Matters

**Always deploy WebSocket workers BEFORE the main app:**

```bash
# âœ… CORRECT ORDER
npm run deploy:websockets  # Deploy specific routes first
npm run deploy             # Deploy wildcard route last

# OR use the combined command (does this automatically)
npm run deploy:all
```

### Why This Matters

The main app uses a **wildcard route** (`ameenuddin.dev/*`) that catches all requests. If deployed first, it can override the WebSocket worker routes. Cloudflare uses route specificity, but deployment order affects registration priority.

### Route Precedence

After correct deployment:
1. âœ… `/demo/api/ai/transcription` â†’ `ameenuddin-transcription-ws`
2. âœ… `/demo/api/ai/tts-stream` â†’ `ameenuddin-tts-ws`
3. âœ… `/*` (everything else) â†’ `ameenuddin`

---

## Architecture Overview

### TanStack Start + Cloudflare Workers

This is a **fullstack Cloudflare Worker application** that runs:
- **Frontend**: Static assets served from the Worker
- **Backend**: Server-side rendering (SSR) + API routes in the Worker
- **Single Worker**: Both frontend and backend run in the same Cloudflare Worker

### Key Concept

TanStack Start uses `@tanstack/react-start/server-entry` as the Worker entry point. This is the recommended approach that:
- Handles SSR (server-side rendering)
- Serves static assets via the `ASSETS` binding
- Routes API calls to server functions
- Integrates seamlessly with TanStack Router

## Build Output Structure

```
dist/
â”œâ”€â”€ server/                      # Server-side code (deployed to Workers)
â”‚   â”œâ”€â”€ index.js                # Server entry (imports worker-entry)
â”‚   â”œâ”€â”€ wrangler.json          # Generated Wrangler config (by TanStack Start)
â”‚   â””â”€â”€ assets/                # Server-side bundles
â”‚       â””â”€â”€ worker-entry-*.js  # Actual Worker code (SSR + API routes)
â””â”€â”€ client/                     # Static assets (served via ASSETS binding)
    â”œâ”€â”€ assets/                # Client-side React bundles + CSS
    â”œâ”€â”€ *.jpg, *.png          # Static images
    â””â”€â”€ favicon.ico           # Favicon
```

## How It Works

### 1. Vite Build Process

**Configuration**: `vite.config.ts`

```typescript
export default defineConfig({
  plugins: [
    tsconfigPaths(),
    tanstackStart(),                              // TanStack Start SSR
    react(),
    cloudflare({ viteEnvironment: { name: "ssr" } }), // Cloudflare adapter
    contentCollections(),
    tailwindcss(),
  ],
  build: {
    rollupOptions: {
      external: ["@cloudflare/ai", "cloudflare:ai"], // Externalize Cloudflare bindings
    },
  },
});
```

**What happens**:
1. TanStack Start generates `dist/server/` with SSR + API route code
2. Vite generates `dist/client/` with static assets + client code
3. **TanStack Start generates `dist/server/wrangler.json`** - a complete Wrangler config that merges:
   - Your `wrangler.jsonc` settings (bindings, compatibility date, etc.)
   - TanStack Start's required settings (`main: "index.js"`, `assets: "../client"`)

### 2. Generated Wrangler Configuration

**File**: `dist/server/wrangler.json` (auto-generated by TanStack Start)

TanStack Start creates a complete Wrangler configuration that includes:

```json
{
  "name": "ameenuddin",
  "main": "index.js",                    // Points to dist/server/index.js
  "assets": {
    "directory": "../client",             // Points to dist/client/
    "binding": "ASSETS"
  },
  "compatibility_date": "2025-09-02",
  "compatibility_flags": ["nodejs_compat"],
  "d1_databases": [...],                  // From your wrangler.jsonc
  "ai": {...},                            // From your wrangler.jsonc
  "kv_namespaces": [...]                  // From your wrangler.jsonc
}
```

**Key points**:
- `main: "index.js"` - Relative to `dist/server/`, so it uses `dist/server/index.js`
- `assets.directory: "../client"` - Points to `dist/client/` for static files
- Merges all bindings from your `wrangler.jsonc`

### 3. User Configuration

**File**: `wrangler.jsonc` (your configuration)

This is where you define your Cloudflare bindings and settings:

```jsonc
{
  "name": "ameenuddin",
  "compatibility_date": "2025-09-02",
  "compatibility_flags": ["nodejs_compat"],
  "main": "@tanstack/react-start/server-entry",  // TanStack Start entry point
  "assets": {
    "directory": "dist/client",
    "binding": "ASSETS"
  },
  "d1_databases": [{
    "binding": "DB",
    "database_name": "ameenuddin-dev-db",
    "database_id": "..."
  }],
  "ai": {
    "binding": "AI"
  },
  "kv_namespaces": [...]
}
```

**Important**: TanStack Start will **override** the `main` setting in the generated `wrangler.json` to point to `dist/server/index.js`, so it's fine to reference `@tanstack/react-start/server-entry` in your `wrangler.jsonc` - it's more documentation than functional.

### 4. Deployment

**Commands**:
```bash
npm run deploy
# Runs: npm run build && wrangler deploy --config dist/server/wrangler.json
```

This uses the **generated** `dist/server/wrangler.json` which has all the correct paths and merged configuration.

## Local Development

### Development Mode (Hot Reload)

```bash
npm run dev
```

Runs Vite dev server with fast refresh (client-side only, no SSR).

### Worker Preview (SSR + API Routes)

```bash
npm run dev:worker
```

Builds the app and runs `wrangler dev` with:
- âœ… Full SSR
- âœ… API routes (server functions)
- âœ… Cloudflare bindings (D1, AI, KV)
- âœ… Static asset serving via ASSETS binding

## Server Entry Point

### TanStack Start's Server Entry

**File**: `@tanstack/react-start/server-entry` (from node_modules)

```typescript
import { createStartHandler, defaultStreamHandler } from "@tanstack/react-start/server";

const fetch = createStartHandler(defaultStreamHandler);

function createServerEntry(entry) {
  return {
    async fetch(...args) {
      return await entry.fetch(...args);
    }
  };
}

const server = createServerEntry({ fetch });
export default server;
```

This creates a Cloudflare Worker-compatible `fetch` handler that:
1. Handles SSR requests (HTML rendering)
2. Routes API calls to server functions (`src/routes/api/`)
3. Serves static assets from the `ASSETS` binding
4. Integrates with TanStack Router

### Your Server Definition

**File**: `src/start/server.tsx`

```typescript
import { StartServer } from "@tanstack/react-start/server";
import { getRouter } from "../router";

const router = getRouter();

export default new StartServer({ router });
```

This creates the TanStack Start server instance with your router configuration.

### How Requests Flow

```
Browser Request
    â†“
Cloudflare Worker
    â†“
dist/server/index.js (entry point)
    â†“
dist/server/assets/worker-entry-*.js (compiled Worker code)
    â†“
TanStack Start Server Handler
    â†“
â”œâ”€â†’ SSR: Renders React components on server
â”œâ”€â†’ API Routes: Executes server functions
â””â”€â†’ Static Assets: Returns files from ASSETS binding (dist/client/)
```

## Environment Bindings

### Available in Server Functions

All server functions (`src/routes/api/`) have access to:

```typescript
import type { Ai } from "@cloudflare/ai";
import type { D1Database, KVNamespace } from "@cloudflare/workers-types";

interface CloudflareEnv {
  DB: D1Database;              // D1 SQL database
  AI: Ai;                      // Workers AI
  PROJECT_CACHE: KVNamespace;  // KV cache
  RATE_LIMIT: KVNamespace;     // Rate limiting
  ASSETS: Fetcher;             // Static assets binding
}

// Access in server functions
export const Route = createFileRoute("/api/search")({
  POST: async ({ request, context }) => {
    const env = context.cloudflare?.env as CloudflareEnv;

    // Use Workers AI
    const result = await env.AI.run("@cf/meta/llama-2-7b-chat-int8", {
      prompt: "Hello"
    });

    // Query D1
    const data = await env.DB.prepare("SELECT * FROM projects").all();

    // Use KV
    await env.PROJECT_CACHE.put("key", "value");

    return { result, data };
  },
});
```

## Deployment Commands

### Build

```bash
npm run build
```

Outputs:
- `dist/server/` - Worker code + generated wrangler.json
- `dist/client/` - Static assets

### Deploy to Cloudflare Workers

```bash
npm run deploy
```

Uses `wrangler deploy --config dist/server/wrangler.json` to deploy the Worker with the TanStack Start-generated configuration.

### Development with Workers Runtime

```bash
npm run dev:worker
```

Runs the Worker locally with Wrangler's local dev environment.

## Troubleshooting

### Build Fails

**Cause**: Vite build error or TanStack Start configuration issue.

**Fix**:
```bash
# Clean and rebuild
rm -rf dist
npm run build
```

### Worker Bindings Not Available

**Cause**: Bindings not configured in `wrangler.jsonc` or Cloudflare Dashboard.

**Fix**:
1. Ensure bindings are in `wrangler.jsonc`
2. For production, verify bindings in Cloudflare Dashboard â†’ Workers & Pages â†’ Your Worker â†’ Settings â†’ Variables and Bindings

### SSR Not Working

**Cause**: TanStack Start not generating correct output.

**Check**:
```bash
# Verify build output structure
ls -la dist/server/
ls -la dist/client/

# Verify generated wrangler.json
cat dist/server/wrangler.json | jq '.main, .assets'
# Should output:
# "index.js"
# { "directory": "../client", "binding": "ASSETS" }
```

### Worker Entry Not Found

**Cause**: Missing or incorrect worker-entry bundle.

**Check**:
```bash
# Verify worker-entry exists
ls -lh dist/server/assets/worker-entry-*.js

# Check index.js imports it correctly
cat dist/server/index.js
# Should see: import { I, H } from "./assets/worker-entry-*.js";
```

### Assets Not Serving

**Cause**: ASSETS binding not configured or path incorrect.

**Check**:
1. Verify `wrangler.jsonc` has `assets` configuration
2. Verify `dist/client/` exists and has files
3. Check generated `dist/server/wrangler.json` has correct assets path

## Architecture Decisions

### Why Use Generated wrangler.json?

**Problem**: TanStack Start needs to control certain Wrangler settings (like `main` and `assets`) while preserving user settings (like bindings).

**Solution**: TanStack Start generates `dist/server/wrangler.json` that merges:
- User's `wrangler.jsonc` (bindings, compatibility, etc.)
- TanStack Start's requirements (`main`, `assets` paths)

**Alternative** (not used): Manually sync configurations - error-prone and breaks TanStack Start's conventions.

### Why @tanstack/react-start/server-entry?

**Reason**: It's the officially supported entry point that:
- Works out of the box with Cloudflare Workers
- Handles SSR, API routes, and static assets
- Integrates with TanStack Router
- Supports streaming SSR

**Alternative** (not used): Custom Worker script - requires reimplementing TanStack Start's request handling logic.

### Why Keep wrangler.jsonc?

**Reason**:
- Source of truth for your bindings (D1, AI, KV)
- Used by TanStack Start to generate the final `wrangler.json`
- Supports comments (`.jsonc` format)
- Version controlled

**Production**: The generated `dist/server/wrangler.json` is used for actual deployment.

### Why Not Cloudflare Pages?

**Reason**: You're using **pure Cloudflare Workers**, which gives you:
- Full control over Worker behavior
- No Pages-specific limitations
- Direct Worker deployment
- Better for complex server-side logic

**Cloudflare Pages** is better for:
- Simpler SSR needs
- Git-based deployments
- Automatic branch previews

## Summary

This setup provides a **fully functional fullstack Cloudflare Worker application** with:

âœ… Server-Side Rendering (SSR) via TanStack Start
âœ… API Routes (server functions)
âœ… Cloudflare bindings (D1, AI, KV, Assets)
âœ… Type-safe routing (TanStack Router)
âœ… Hot reload in development
âœ… Production-optimized builds
âœ… Pure Cloudflare Workers deployment (not Pages)

**Key Files**:
- `wrangler.jsonc` - Your configuration (bindings, settings)
- `dist/server/wrangler.json` - Generated by TanStack Start (merged config)
- `vite.config.ts` - Build configuration
- `src/start/server.tsx` - Your server definition
- `@tanstack/react-start/server-entry` - TanStack's Worker entry point

**Deploy Command**:
```bash
npm run deploy
```

That's it! ðŸš€
