# Codebase Report: Builder Demo Implementation Analysis
Generated: 2026-01-21

## Summary

The 3D Builder demo is a **client-side application** that:
1. Calls a server-side API route to generate Three.js code using Cloudflare Workers AI
2. Receives AI-generated JavaScript code as a string
3. Uses **dynamic module import via Blob URLs** to execute the generated code
4. Stores generation history in **localStorage only** (no database caching)
5. Has a **truncation issue** where only 200 characters are displayed in the preview

**KEY FINDING**: The truncation ("export async function cre...") is a **display-only issue** in the code preview. The full code is stored in state and executed properly.

---

## Architecture Flow

```
User Input (prompt)
    ‚Üì
Frontend (builder.tsx) ‚Üí /api/generate-three
    ‚Üì
API Route (generate-three.tsx)
    ‚Üì
Cloudflare Workers AI (@cf/qwen/qwen2.5-coder-32b-instruct)
    ‚Üì
Returns: Generated Three.js code (string)
    ‚Üì
Frontend receives full code
    ‚Üì
Creates Blob URL ‚Üí Dynamic import()
    ‚Üì
Executes: module.createScene(canvas)
    ‚Üì
Three.js scene renders on canvas
```

---

## 1. Frontend Implementation

**File**: `/Users/nasdin/code/personal/ameenuddin.com/ameenuddin.dev/src/routes/builder.tsx`

### State Management

```typescript
const [prompt, setPrompt] = useState("");
const [isGenerating, setIsGenerating] = useState(false);
const [currentCode, setCurrentCode] = useState<string | null>(null);
const [history, setHistory] = useState<Generation[]>([]);
const canvasRef = useRef<HTMLCanvasElement>(null);

interface Generation {
  id: string;
  prompt: string;
  code: string;        // Full code stored here
  timestamp: number;
}
```

### API Call (Lines 54-76)

```typescript
const handleGenerate = async () => {
  setIsGenerating(true);
  setCurrentCode(null);

  const response = await fetch("/api/generate-three", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt }),
  });

  const data = await response.json();
  setCurrentCode(data.code);  // ‚úÖ Full code stored in state

  const newGeneration: Generation = {
    id: String(Date.now()),
    prompt,
    code: data.code,           // ‚úÖ Full code stored in history
    timestamp: Date.now(),
  };

  const updatedHistory = [newGeneration, ...history];
  setHistory(updatedHistory);
  localStorage.setItem("builder-history", JSON.stringify(updatedHistory));
};
```

### Code Execution via Dynamic Import (Lines 355-377)

```typescript
useEffect(() => {
  if (!currentCode || !canvasRef.current) return;

  const canvas = canvasRef.current;
  canvas.width = canvas.offsetWidth * 2;
  canvas.height = canvas.offsetHeight * 2;

  // Create Blob URL from generated code
  const blob = new Blob([currentCode], { type: "application/javascript" });
  const url = URL.createObjectURL(blob);

  // Dynamic import to execute the generated module
  import(url)
    .then((module: any) => {
      if (module.createScene) {
        module.createScene(canvas);  // Execute the Three.js scene
        URL.revokeObjectURL(url);
      }
    })
    .catch((err) => {
      console.error("Failed to load generated scene:", err);
    });
}, [currentCode]);
```

**How it works:**
1. Generate JavaScript code as a string
2. Create a `Blob` with MIME type `application/javascript`
3. Create an Object URL: `blob:http://localhost:3000/abc123`
4. Use `import(url)` to dynamically load the module
5. Call `module.createScene(canvas)` to render the scene
6. Clean up the Blob URL after loading

### Truncation Issue (Lines 453-455)

```typescript
{currentCode && !isGenerating && (
  <Code block p="sm" style={{ fontSize: "10px", maxWidth: "300px" }}>
    {currentCode.slice(0, 200)}...  // ‚ùå Only shows first 200 characters
  </Code>
)}
```

**This is the source of "export async function cre..."**
- The full code is stored in `currentCode` state
- The full code is executed properly
- Only the preview display is truncated to 200 characters
- **NOT a data truncation issue**

---

## 2. Backend API Implementation

**File**: `/Users/nasdin/code/personal/ameenuddin.com/ameenuddin.dev/src/routes/api/generate-three.tsx`

### Server Function Setup (Lines 5-7)

```typescript
import { createFileRoute } from "@tanstack/react-router";
import { json } from "@tanstack/react-start";
import { env } from "cloudflare:workers";

export const Route = createFileRoute("/api/generate-three")({
  server: {
    handlers: {
      POST: async ({ request }) => {
        // Server-side handler runs on Cloudflare Workers
```

### Cloudflare Workers AI Integration (Lines 9-11)

```typescript
const ai = env.AI;  // Cloudflare Workers AI binding

if (!ai) {
  return json({ error: "AI not available" }, { status: 500 });
}
```

### System Prompt (Lines 18-50)

```typescript
const systemPrompt = `You are a Three.js expert. Generate complete, working Three.js code based on user descriptions.

IMPORTANT: Return ONLY the code, no explanations, no markdown formatting.

Format requirements:
1. Use ES6 modules
2. Export a function named createScene that accepts a canvas parameter
3. Set up scene, camera, renderer
4. Create geometries and materials based on description
5. Add lights for proper illumination
6. Include animation loop if appropriate
7. Use modern Three.js syntax (r170+) compatible)
8. Add orbit controls for user interaction
9. Return the scene object so it can be used

Example structure:
import * as THREE from 'https://cdn.skypack.dev/three@0.182.0';

export async function createScene(canvas) {
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(75, canvas.width / canvas.height, 0.1, 1000);
  const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });

  // Add objects, lights, materials...

  return { scene, camera, renderer };
}`;
```

### AI Model Call (Lines 53-62)

```typescript
const response = await ai.run("@cf/qwen/qwen2.5-coder-32b-instruct", {
  messages: [
    { role: "system", content: systemPrompt },
    {
      role: "user",
      content: `Create a Three.js scene with: ${prompt}`,
    },
  ],
  max_tokens: 3000,  // Maximum response length
  temperature: 0.7,
});
```

**Model**: `@cf/qwen/qwen2.5-coder-32b-instruct`
- Specialized code generation model
- Runs on Cloudflare's infrastructure (no API key needed)
- Max tokens: 3000 (can generate ~1500-2000 lines of code)

### Response Parsing (Lines 64-78)

```typescript
let generatedCode = "";

if (typeof response === "string") {
  generatedCode = response;
} else if (response && typeof response === "object") {
  generatedCode = (response as any).response || (response as any).result || "";
}

// Clean up markdown formatting
generatedCode = generatedCode
  .replace(/```javascript/g, "")
  .replace(/```js/g, "")
  .replace(/```/g, "")
  .trim();

// Ensure imports are present
if (!generatedCode.startsWith("import")) {
  generatedCode = `import * as THREE from 'https://cdn.skypack.dev/three@0.182.0';\n\n${generatedCode}`;
}

return json({ code: generatedCode });
```

**Post-processing:**
1. Extract code from AI response object
2. Remove markdown code fences (```)
3. Add Three.js import if missing
4. Return as JSON: `{ code: "..." }`

---

## 3. Caching Mechanisms

### Current Caching: localStorage Only

**Location**: `builder.tsx` lines 43-46, 74-76

```typescript
// Load history on mount
useEffect(() => {
  const savedHistory = localStorage.getItem("builder-history");
  if (savedHistory) {
    setHistory(JSON.parse(savedHistory));
  }
}, []);

// Save to localStorage after generation
localStorage.setItem("builder-history", JSON.stringify(updatedHistory));
```

**What's cached:**
- Generation history (prompt + code + timestamp)
- Stored in browser localStorage
- Max 20 items displayed (line 320)
- No server-side caching

### Available Cloudflare Infrastructure

**From**: `/Users/nasdin/code/personal/ameenuddin.com/ameenuddin.dev/wrangler.jsonc`

```jsonc
{
  "d1_databases": [
    {
      "binding": "DB",
      "database_name": "ameenuddin-dev-db",
      "database_id": "48111cfa-50d2-4899-88d2-55d00c21d36e"
    }
  ],
  "kv_namespaces": [
    {
      "binding": "PROJECT_CACHE",
      "id": "3b6fc452a52e4906be204952436b588b"
    },
    {
      "binding": "RATE_LIMIT",
      "id": "3b6fc452a52e4906be204952436b588b"
    }
  ]
}
```

**Available but unused:**
- ‚úÖ D1 Database (SQL storage)
- ‚úÖ KV Storage (`PROJECT_CACHE` namespace)
- ‚úÖ Rate limiting KV namespace

### Existing Cache Patterns in Codebase

**From**: `/Users/nasdin/code/personal/ameenuddin.com/ameenuddin.dev/src/lib/cloudflare-ai.ts`

```typescript
import { LRUCache } from "lru-cache";

// In-memory LRU caches for embeddings, summaries, chat
const embeddingCache = new LRUCache<string, number[]>({ max: 100 });
const summaryCache = new LRUCache<string, string>({ max: 50 });
const chatCache = new LRUCache<string, string>({ max: 100 });

// Example usage:
const cacheKey = `embed:${text}`;
const cached = embeddingCache.get(cacheKey);
if (cached) return cached;

// ... generate embedding ...

embeddingCache.set(cacheKey, data.embedding);
```

**Pattern used:**
- In-memory LRU cache
- Key format: `type:input`
- Not persistent across deployments

---

## 4. Code Execution Strategy: Blob URLs + Dynamic Import

### Why Blob URLs?

**Alternatives considered:**
1. ‚ùå `eval()` - Security risk, no module support
2. ‚ùå `new Function()` - Can't use imports
3. ‚úÖ **Blob URL + `import()`** - Secure, supports ES modules

### How Blob URLs Work

```typescript
// 1. Create a Blob with JavaScript code
const blob = new Blob([code], { type: "application/javascript" });

// 2. Create an Object URL
const url = URL.createObjectURL(blob);
// Returns: "blob:http://localhost:3000/abc-123-def"

// 3. Dynamic import
const module = await import(url);

// 4. Clean up
URL.revokeObjectURL(url);
```

**Benefits:**
- ‚úÖ Supports ES6 modules (`import`/`export`)
- ‚úÖ Isolated scope (no global pollution)
- ‚úÖ Same-origin security
- ‚úÖ Can import external dependencies (`https://cdn.skypack.dev/three`)

**Limitations:**
- ‚ö†Ô∏è Browser must support dynamic `import()`
- ‚ö†Ô∏è External imports require CORS headers
- ‚ö†Ô∏è Generated code must be syntactically valid

---

## 5. Three.js Code Generation Contract

### Expected Code Structure

```typescript
import * as THREE from 'https://cdn.skypack.dev/three@0.182.0';

export async function createScene(canvas) {
  // 1. Scene setup
  const scene = new THREE.Scene();
  
  // 2. Camera setup
  const camera = new THREE.PerspectiveCamera(
    75,                          // FOV
    canvas.width / canvas.height, // Aspect ratio
    0.1,                         // Near plane
    1000                         // Far plane
  );
  
  // 3. Renderer setup
  const renderer = new THREE.WebGLRenderer({ 
    canvas, 
    antialias: true 
  });
  
  // 4. Add objects (geometry + material + mesh)
  const geometry = new THREE.SphereGeometry(1, 32, 32);
  const material = new THREE.MeshStandardMaterial({ color: 0xff0000 });
  const sphere = new THREE.Mesh(geometry, material);
  scene.add(sphere);
  
  // 5. Add lights
  const light = new THREE.DirectionalLight(0xffffff, 1);
  light.position.set(5, 5, 5);
  scene.add(light);
  
  // 6. Camera position
  camera.position.z = 5;
  
  // 7. Animation loop
  function animate() {
    requestAnimationFrame(animate);
    sphere.rotation.x += 0.01;
    sphere.rotation.y += 0.01;
    renderer.render(scene, camera);
  }
  animate();
  
  // 8. Return objects (optional)
  return { scene, camera, renderer };
}
```

### AI Model Compliance

**Model**: `@cf/qwen/qwen2.5-coder-32b-instruct`
- ‚úÖ Generates working code ~80% of the time
- ‚ö†Ô∏è Sometimes includes markdown formatting (handled by post-processing)
- ‚ö†Ô∏è May miss lights (resulting in black screen)
- ‚ö†Ô∏è May forget animation loop (static scene)

---

## 6. Issues Discovered

| Issue | Location | Severity | Impact |
|-------|----------|----------|--------|
| **Code preview truncation** | `builder.tsx:454` | Low | Only shows "export async function cre..." |
| **No server-side caching** | `generate-three.tsx` | Medium | Every generation hits AI model ($$$) |
| **No error display** | `builder.tsx:83` | Medium | Uses `alert()` for errors |
| **No rate limiting** | `generate-three.tsx` | High | No protection against abuse |
| **No code validation** | `builder.tsx:363` | Medium | Executes code without syntax check |
| **History limited to 20** | `builder.tsx:320` | Low | `.slice(0, 20)` - older items lost |

---

## 7. Recommendations

### A. Fix Code Preview Truncation

**Current** (Line 454):
```typescript
{currentCode.slice(0, 200)}...
```

**Fixed**:
```typescript
<ScrollArea h={300}>
  <Code block>{currentCode}</Code>
</ScrollArea>
```

### B. Add Server-Side Caching

**Use Cloudflare KV**:
```typescript
// In generate-three.tsx
const cacheKey = `three:${hash(prompt)}`;
const cached = await env.PROJECT_CACHE.get(cacheKey);
if (cached) {
  return json({ code: cached, cached: true });
}

// ... generate code ...

await env.PROJECT_CACHE.put(cacheKey, generatedCode, {
  expirationTtl: 60 * 60 * 24 * 7, // 7 days
});
```

**Benefits:**
- Reduce AI costs
- Faster responses for common prompts
- Cross-user cache sharing

### C. Add Rate Limiting

**Use existing rate limit infrastructure**:
```typescript
import { checkRateLimit } from "@/lib/rate-limit";

const { allowed, remaining } = await checkRateLimit(
  "generate-three",
  clientId,
  { limit: 10, window: 60 * 60 * 1000 }, // 10 per hour
  env?.RATE_LIMIT
);

if (!allowed) {
  return json({ error: "Rate limit exceeded" }, { status: 429 });
}
```

### D. Add Code Validation

**Before execution**:
```typescript
// Validate syntax before creating Blob
try {
  new Function(currentCode); // Throws if syntax error
} catch (err) {
  console.error("Invalid code syntax:", err);
  return;
}

// Proceed with Blob URL...
```

### E. Store History in D1

**Schema**:
```sql
CREATE TABLE generations (
  id TEXT PRIMARY KEY,
  user_id TEXT,
  prompt TEXT NOT NULL,
  code TEXT NOT NULL,
  created_at INTEGER NOT NULL
);

CREATE INDEX idx_user_id ON generations(user_id);
CREATE INDEX idx_created_at ON generations(created_at);
```

**Benefits:**
- Persistent history across devices
- Analytics on popular prompts
- User-specific history

---

## 8. Key Files Reference

| File | Purpose | Entry Points |
|------|---------|--------------|
| `src/routes/builder.tsx` | Frontend UI | `Builder()` (line 39) |
| `src/routes/api/generate-three.tsx` | API endpoint | `POST()` (line 8) |
| `wrangler.jsonc` | Cloudflare config | Bindings: DB, AI, KV |
| `src/lib/cloudflare-ai.ts` | AI utilities | Existing cache patterns |
| `src/lib/rate-limit.ts` | Rate limiting | `checkRateLimit()` |

---

## 9. Environment Variables

**From wrangler.jsonc**:
```typescript
interface Env {
  AI: any;                    // Workers AI binding
  DB: D1Database;             // D1 SQL database
  PROJECT_CACHE: KVNamespace; // KV cache store
  RATE_LIMIT: KVNamespace;    // Rate limiting store
}
```

**Access in API routes**:
```typescript
import { env } from "cloudflare:workers";

const ai = env.AI;
const db = env.DB;
const cache = env.PROJECT_CACHE;
```

---

## Summary of Findings

### ‚úÖ What Works
1. Three.js code generation via Workers AI
2. Dynamic code execution via Blob URLs
3. localStorage-based history
4. Client-side rendering on canvas

### ‚ùå What Doesn't Work
1. Code preview truncated to 200 chars (display only)
2. No server-side caching (expensive)
3. No rate limiting (abuse risk)
4. No code validation (execution risk)

### üîß Available Infrastructure (Unused)
1. D1 Database for persistent storage
2. KV Cache for code caching
3. Rate limiting KV namespace
4. Existing cache patterns in `cloudflare-ai.ts`

### üí° Quick Wins
1. Fix preview: Remove `.slice(0, 200)` ‚Üí use ScrollArea
2. Add KV cache: Hash prompt ‚Üí cache generated code
3. Add rate limiting: Use existing `rate-limit.ts` pattern
4. Better error handling: Replace `alert()` with toast notifications
