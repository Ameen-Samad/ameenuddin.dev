# Codebase Report: Chatbot & Toaster Investigation
Generated: 2026-01-21

## Summary
Found the chatbot component and notification system. The toaster uses Mantine's `@mantine/notifications` with a z-index of 9999 positioned at top-right. The chatbot messages are displayed in a ScrollArea inside the chat interface. Identified potential z-index conflicts and message visibility issues.

## Project Structure
```
src/
├── routes/
│   ├── __root.tsx              # Root layout with <Notifications> component
│   ├── chatbot.tsx             # Main chatbot component (970 lines)
│   └── api/
│       └── chat.tsx            # Chat API endpoint
├── components/
│   ├── WhatsAppButton.tsx      # Fixed position button (z-index: 1000)
│   └── [various components]
├── lib/
│   ├── streaming-chat-hook.ts  # Chat streaming hook
│   └── demo-chat-hook.ts       # Demo chat functionality
└── styles.css                  # Global styles
```

## Questions Answered

### Q1: Where is the Chatbot component?
**Location:** `/Users/nasdin/code/personal/ameenuddin.com/ameenuddin.dev/src/routes/chatbot.tsx`
**Entry Point:** Exported as route at `/chatbot`
**Key Functions:**
- `Chatbot()` (line 52) - Main component
- `ChatArea()` (line 747) - Message display area
- `DocumentSidebar()` (line 637) - RAG document sidebar
- `handleSendMessage()` (line 94) - Sends messages and handles streaming

### Q2: Where is the Toaster/Notification component?
**Location:** `/Users/nasdin/code/personal/ameenuddin.com/ameenuddin.dev/src/routes/__root.tsx`
**Implementation:** Mantine Notifications
```tsx
<Notifications position="top-right" zIndex={9999} />
```
**Usage in Chatbot:** Line 19 imports `notifications`, line 135 shows notification
**Notification trigger:** When RAG context is retrieved (line 132-194)

### Q3: How are messages displayed?
**Component:** `ChatArea` (lines 747-970)
**Container:** ScrollArea with fixed height of 700px (line 811)
**Message Rendering:**
- Messages array mapped at line 837
- Each message wrapped in `motion.div` with fade-in animation
- Streaming content displayed separately at line 897-926
- Auto-scroll via `messagesEndRef` (line 928)

## Architecture Map

```
[User Input] --> [handleSendMessage] --> [POST /api/chat]
                                              |
                                         [Streaming Response]
                                              |
                      +-------------------+---+--------------------+
                      |                   |                        |
                [data: context]      [data: content]          [data: done]
                      |                   |                        |
              [Show notification]   [Update streaming]    [Finalize message]
              (lines 132-194)       (lines 196-198)      (lines 210-220)
```

## Key Files

| File | Purpose | Key Lines |
|------|---------|-----------|
| `src/routes/chatbot.tsx` | Main chatbot UI | 52 (component), 94 (send), 747 (chat area) |
| `src/routes/__root.tsx` | Root layout with toaster | 94 (Notifications component) |
| `src/routes/api/chat.tsx` | Backend chat endpoint | - |
| `src/lib/streaming-chat-hook.ts` | Chat streaming logic | - |

## Issues Identified

### 1. Toaster Cut-Off Issue
**Root Cause Analysis:**
- Notifications component has `zIndex={9999}` (highest priority)
- Positioned at `top-right` in root layout
- **Potential issue:** Parent containers may have `overflow: hidden` or lower z-index

**Relevant Code:**
```tsx
// __root.tsx line 94
<Notifications position="top-right" zIndex={9999} />

// Chatbot container (line 309)
<div style={{ minHeight: "100vh", background: "#0a0a0a" }}>
```

**✓ VERIFIED:** No `overflow: hidden` on main chatbot container

### 2. Message Display After Notification
**How it works:**
1. User sends message → adds to messages array (line 98)
2. Streaming starts → `isStreamingRef.current = true` (line 101)
3. Context received → notification.show() (line 135)
4. Content chunks → updates `streamingContent` (line 198)
5. Done event → finalizes message (lines 211-217)

**Potential Issue:**
- Streaming content displayed in separate `<motion.div>` (lines 897-926)
- When notification appears, it may cover the top of the ScrollArea
- Messages should still render, but may be visually obscured

### 3. Z-Index Stack

| Component | Z-Index | Position |
|-----------|---------|----------|
| Notifications | 9999 | top-right (fixed) |
| WhatsAppButton | 1000 | bottom-right (fixed) |
| Chat components | default | relative |

**Conflict:** None detected, but notification at z-index 9999 should always be on top.

## Message Streaming Flow

```typescript
// Line 122-223
while (true) {
  const { done, value } = await reader.read();
  const lines = chunk.split("\n");
  
  for (const line of lines) {
    if (line.startsWith("data: ")) {
      const data = JSON.parse(line.slice(6));
      
      // 1. Context notification (lines 132-194)
      if (data.type === "context") {
        notifications.show({ /* RAG context */ });
      }
      
      // 2. Content streaming (lines 196-198)
      else if (data.type === "content") {
        fullContent += data.content;
        setStreamingContent(fullContent);
      }
      
      // 3. Finalize (lines 210-220)
      else if (data.type === "done") {
        setMessages(prev => [...prev, { content: fullContent }]);
        setStreamingContent("");
      }
    }
  }
}
```

## Notification Component Details

**Location in DOM:**
```tsx
// __root.tsx (lines 59-100)
<body>
  <MantineProvider>
    <Sidebar />
    <MobileNav />
    <div className="ml-0 md:ml-[280px]">
      {children} <!-- Chatbot renders here -->
    </div>
    <WhatsAppButton />
    <Notifications position="top-right" zIndex={9999} /> <!-- HERE -->
  </MantineProvider>
</body>
```

**Notification Content (lines 135-194):**
```tsx
notifications.show({
  id: `rag-context-${Date.now()}`,
  title: <Group><IconDatabase /> RAG Context Applied</Group>,
  message: <Stack>
    {data.context.map(doc => (
      <Paper /* clickable document preview */ />
    ))}
  </Stack>,
  color: "cyan",
  autoClose: 8000,
  withCloseButton: true,
});
```

## Chat ScrollArea Details

**Component Structure (lines 811-930):**
```tsx
<ScrollArea flex={1} h={700} p="md">
  <Stack gap="md">
    {/* Empty state */}
    {messages.length === 0 && <EmptyState />}
    
    {/* Rendered messages */}
    {messages.map((msg, idx) => (
      <motion.div /* fade in animation */>
        <Paper /* message bubble */>
          <ReactMarkdown>{msg.content}</ReactMarkdown>
        </Paper>
      </motion.div>
    ))}
    
    {/* Streaming content (separate from messages array) */}
    {streamingContent && (
      <motion.div>
        <Paper>
          <ReactMarkdown>{streamingContent}</ReactMarkdown>
        </Paper>
      </motion.div>
    )}
    
    <div ref={messagesEndRef} /> <!-- Auto-scroll target -->
  </Stack>
</ScrollArea>
```

## Debugging Checklist

### For Toaster Cut-Off:
- [x] Verify z-index (9999 confirmed)
- [ ] Check parent container overflow
- [ ] Inspect Mantine Notifications styles in DevTools
- [ ] Test on different screen sizes
- [ ] Check if sidebar (z-index unknown) overlaps

### For Message Display:
- [ ] Console.log `streamingContent` state during streaming
- [ ] Verify `data.type === "content"` events are received
- [ ] Check if ScrollArea height (700px) is sufficient
- [ ] Test auto-scroll behavior (`messagesEndRef.current?.scrollIntoView()`)
- [ ] Verify `isStreamingRef.current` state transitions

## Code Snippets

### Auto-scroll Implementation
```tsx
// Lines 86-92
const scrollToBottom = () => {
  messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
};

useEffect(() => {
  scrollToBottom();
}, [messages, streamingContent]);
```

### Streaming Content Display
```tsx
// Lines 897-926
{streamingContent && (
  <motion.div
    initial={{ opacity: 0 }}
    animate={{ opacity: 1 }}
  >
    <Paper
      p="md"
      style={{
        background: "rgba(255, 0, 255, 0.1)",
        border: "1px solid #ff00ff30",
      }}
    >
      <Badge>AI</Badge>
      <Text>Streaming...</Text>
      <ReactMarkdown>{streamingContent}</ReactMarkdown>
    </Paper>
  </motion.div>
)}
```

## Next Steps

1. **Inspect in browser DevTools:**
   - Check computed styles on `<Notifications>` component
   - Verify notification position and visibility
   - Check z-index stacking context

2. **Add debug logging:**
   ```tsx
   console.log("Streaming content:", streamingContent);
   console.log("Is streaming:", isStreamingRef.current);
   console.log("Messages:", messages);
   ```

3. **Test notification positioning:**
   - Manually trigger notification without chat
   - Check if issue is specific to notification content size
   - Test with shorter notification messages

4. **Verify CSS conflicts:**
   - Check if Mantine styles are loaded correctly
   - Inspect global `overflow-x: hidden` (lines 147, 160 in styles.css)
   - Check sidebar positioning impact

## Open Questions

1. **Why are messages not showing after notification?**
   - ? INFERRED: State update race condition between `streamingContent` and `messages`
   - ? INFERRED: Notification overlay blocks view, not actual rendering
   - Must verify with browser inspection

2. **Is the toaster actually cut off or just positioned incorrectly?**
   - ? INFERRED: May be positioned outside viewport
   - ? INFERRED: Parent container may have `overflow` clipping
   - Must verify in DevTools

3. **Are there CSS conflicts with Mantine styles?**
   - ✓ VERIFIED: Mantine styles imported at `__root.tsx` line 2
   - ? INFERRED: Potential Tailwind conflicts with Mantine
   - Must check computed styles
